version: '3.7'

name: tracking-detector

services:
  # Infra
  api-gateway:
    restart: unless-stopped
    image: nginx
    ports:
      - 80:80
      - 443:443
      - 8081:8081
    volumes:
      - ./infra/api-gateway/:/etc/nginx:ro
    depends_on:
      - mongo-express
      - export
      - minio
      - grafana
      - requests
      - loki
    networks:
      - app-network
  loki:
    restart: unless-stopped
    image: grafana/loki:2.6.1
    volumes:
      - loki_data:/loki
      - ./infra/loki/loki.yaml:/etc/loki/loki-config.yaml
    networks:
      - app-network
  promtail:
    restart: unless-stopped
    image: grafana/promtail:2.6.1
    volumes:
      - ./infra/promtail/promtail-config.yml:/etc/promtail/config.yml
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers
    networks:
      - app-network
  grafana:
    restart: unless-stopped
    image: grafana/grafana:9.2.2
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./infra/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - app-network
    depends_on:
      - loki
  minio:
    restart: unless-stopped
    image: minio/minio
    container_name: minio
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: adminadmin
      MINIO_ROOT_PASSWORD: adminadmin
    command: server --console-address ":9001" /data
    networks:
      - app-network
  mongo-express:
    restart: unless-stopped
    image: mongo-express:latest
    environment:
      - ME_CONFIG_MONGODB_URL=mongodb://db:27017/tracking-detector
      - ME_CONFIG_MONGODB_ENABLE_ADMIN=false
      - ME_CONFIG_SITE_BASEURL=/mongo
    depends_on:
      - db
    networks:
      - app-network
  db:
    image: mongo:latest
    restart: unless-stopped
    container_name: db
    environment:
      - MONGO_INITDB_DATABASE=tracking-detector
    volumes:
      - mongo_storage:/data/db
    networks:
      - app-network
    depends_on:
      - loki
  # Serverless Functions
  requests:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./go/functions/requests/Dockerfile
    environment:
      - MONGO_URI=${MONGO_URI}
      - USER_COLLECTION=${USER_COLLECTION}
      - REQUEST_COLLECTION=${REQUEST_COLLECTION}
      - TRAINING_RUNS_COLLECTION=${TRAINING_RUNS_COLLECTION}
      - MINIO_URI=${MINIO_URI}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_PRIVATE_KEY=${MINIO_PRIVATE_KEY}
      - EXPORT_BUCKET_NAME=${EXPORT_BUCKET_NAME}
      - MODEL_BUCKET_NAME=${MODEL_BUCKET_NAME}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
    depends_on:
      - minio
      - db
      - loki
    networks:
      - app-network
  export:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./go/functions/export/Dockerfile
    environment:
      - MONGO_URI=${MONGO_URI}
      - USER_COLLECTION=${USER_COLLECTION}
      - REQUEST_COLLECTION=${REQUEST_COLLECTION}
      - TRAINING_RUNS_COLLECTION=${TRAINING_RUNS_COLLECTION}
      - MINIO_URI=${MINIO_URI}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_PRIVATE_KEY=${MINIO_PRIVATE_KEY}
      - EXPORT_BUCKET_NAME=${EXPORT_BUCKET_NAME}
      - MODEL_BUCKET_NAME=${MODEL_BUCKET_NAME}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
    depends_on:
      - minio
      - db
      - loki
    networks:
      - app-network
  download:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./go/functions/download/Dockerfile
    environment:
      - MONGO_URI=${MONGO_URI}
      - USER_COLLECTION=${USER_COLLECTION}
      - REQUEST_COLLECTION=${REQUEST_COLLECTION}
      - TRAINING_RUNS_COLLECTION=${TRAINING_RUNS_COLLECTION}
      - MINIO_URI=${MINIO_URI}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_PRIVATE_KEY=${MINIO_PRIVATE_KEY}
      - EXPORT_BUCKET_NAME=${EXPORT_BUCKET_NAME}
      - MODEL_BUCKET_NAME=${MODEL_BUCKET_NAME}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
    depends_on:
      - minio
      - db
      - loki
    networks:
      - app-network
  auth:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./go/functions/auth/Dockerfile
    environment:
      - MONGO_URI=${MONGO_URI}
      - USER_COLLECTION=${USER_COLLECTION}
      - REQUEST_COLLECTION=${REQUEST_COLLECTION}
      - TRAINING_RUNS_COLLECTION=${TRAINING_RUNS_COLLECTION}
      - MINIO_URI=${MINIO_URI}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_PRIVATE_KEY=${MINIO_PRIVATE_KEY}
      - EXPORT_BUCKET_NAME=${EXPORT_BUCKET_NAME}
      - MODEL_BUCKET_NAME=${MODEL_BUCKET_NAME}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
    depends_on:
      - minio
      - db
      - loki
    networks:
      - app-network
  training:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./python/Dockerfile
    environment:
      - MONGO_URI=${MONGO_URI}
      - USER_COLLECTION=${USER_COLLECTION}
      - REQUEST_COLLECTION=${REQUEST_COLLECTION}
      - TRAINING_RUNS_COLLECTION=${TRAINING_RUNS_COLLECTION}
      - MINIO_URI=${MINIO_URI}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_PRIVATE_KEY=${MINIO_PRIVATE_KEY}
      - EXPORT_BUCKET_NAME=${EXPORT_BUCKET_NAME}
      - MODEL_BUCKET_NAME=${MODEL_BUCKET_NAME}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
    depends_on:
      - minio
      - db
      - loki
    networks:
      - app-network
  training-runs:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./go/functions/training-runs/Dockerfile
    environment:
      - MONGO_URI=${MONGO_URI}
      - USER_COLLECTION=${USER_COLLECTION}
      - REQUEST_COLLECTION=${REQUEST_COLLECTION}
      - TRAINING_RUNS_COLLECTION=${TRAINING_RUNS_COLLECTION}
      - MINIO_URI=${MINIO_URI}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_PRIVATE_KEY=${MINIO_PRIVATE_KEY}
      - EXPORT_BUCKET_NAME=${EXPORT_BUCKET_NAME}
      - MODEL_BUCKET_NAME=${MODEL_BUCKET_NAME}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
    depends_on:
      - minio
      - db
      - loki
    networks:
      - app-network
  front-end:
    restart: unless-stopped
    build: ./td-fe
    environment:
      - MONGO_URI=${MONGO_URI}
      - USER_COLLECTION=${USER_COLLECTION}
      - REQUEST_COLLECTION=${REQUEST_COLLECTION}
      - TRAINING_RUNS_COLLECTION=${TRAINING_RUNS_COLLECTION}
      - MINIO_URI=${MINIO_URI}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_PRIVATE_KEY=${MINIO_PRIVATE_KEY}
      - EXPORT_BUCKET_NAME=${EXPORT_BUCKET_NAME}
      - MODEL_BUCKET_NAME=${MODEL_BUCKET_NAME}
      - NUXT_PUBLIC_API_BASE=${ADMIN_API_KEY}
    networks:
      - app-network

networks:
  app-network:


volumes:
  minio_data: {}
  loki_data: {}
  grafana_data: {}
  data: {}
  mongo_storage: {}
